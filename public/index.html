<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wormate.io Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');

        body { 
            margin: 0; 
            overflow: hidden; 
            background: #1a1a1a; 
            font-family: 'Fredoka', sans-serif;
            touch-action: none; 
            user-select: none;
        }

        /* Oyun Arkaplanƒ± - Wormate Izgarasƒ± */
        #game-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #2c2f33;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 2px, transparent 2px);
            background-size: 80px 80px;
            z-index: -1;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .interactive { pointer-events: auto; }

        /* Wormate Tarzƒ± Panel */
        .wormate-panel {
            background: linear-gradient(to bottom, #b4dd52 0%, #7db72f 100%);
            border: 8px solid #fff;
            border-radius: 40px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2), 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .wormate-panel::after {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px dashed rgba(255,255,255,0.4);
            border-radius: 30px;
            pointer-events: none;
        }

        .play-btn {
            background: linear-gradient(to bottom, #ffeb3b 0%, #fbc02d 100%);
            border: 4px solid #fff;
            border-radius: 50px;
            color: #5d4037;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.4);
            box-shadow: 0 6px 0 #bf9000, 0 10px 10px rgba(0,0,0,0.3);
            transition: all 0.1s;
        }
        .play-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #bf9000;
        }

        /* Powerup Kutucuklarƒ± */
        .powerup-timer {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.6);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 30px;
            padding: 4px 12px;
            margin-bottom: 5px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Mini Map */
        #minimap-wrapper {
            background: rgba(0, 0, 0, 0.5);
            border: 5px solid rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 140px;
            height: 140px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* Skin Canvas */
        #mm-skin-canv {
            background: rgba(0,0,0,0.1);
            border-radius: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        
        /* Input Stilleri */
        .game-input {
            background: white;
            border: 4px solid #8bc34a;
            border-radius: 15px;
            color: #444;
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .game-input:focus {
            border-color: #4caf50;
            outline: none;
        }
    </style>
</head>
<body>

    <!-- Arkaplan ve Canvas -->
    <div id="game-bg"></div>
    <canvas id="gameCanvas" style="display:block;"></canvas>

    <!-- UI LAYER -->
    <div id="ui-layer">
        
        <!-- --- ANA MEN√ú --- -->
        <div id="login-panel" class="interactive absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg px-4 flex flex-col items-center z-50">
            
            <!-- Logo -->
            <div class="mb-2 relative group cursor-default transform hover:scale-105 transition duration-300">
                <h1 class="text-7xl md:text-8xl text-white drop-shadow-[0_8px_0_rgba(0,0,0,0.3)] font-black tracking-tighter" 
                    style="-webkit-text-stroke: 3px #3e2723; text-shadow: 4px 4px 0 #3e2723;">
                    <span class="text-[#ff7675]">WORM</span><span class="text-[#ffeaa7]">EIGHT</span>
                </h1>
            </div>

            <div class="wormate-panel p-6 w-full flex flex-col items-center gap-4">
                
                <!-- Skin √ñnizleme -->
                <div class="relative w-full flex justify-center group">
                    <canvas id="mm-skin-canv" width="400" height="100" class="interactive cursor-pointer"></canvas>
                    <!-- Oklar -->
                    <button onclick="prevSkin()" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 p-2 rounded-full text-white transition"><i class="fas fa-chevron-left"></i></button>
                    <button onclick="nextSkin()" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 p-2 rounded-full text-white transition"><i class="fas fa-chevron-right"></i></button>
                </div>

                <!-- ƒ∞sim ve Sunucu -->
                <div class="w-full space-y-3">
                    <input type="text" id="username" placeholder="Takma Adƒ±n" maxlength="12" 
                        class="game-input w-full text-center text-xl py-3 placeholder-gray-400"
                        value="Oyuncu">
                    
                    <div class="relative">
                        <select id="server-select" class="game-input w-full text-center text-lg py-2 appearance-none cursor-pointer">
                            <option value="wss://wormeight.onrender.com">üá©üá™ Almanya Sunucusu (WormEight)</option>
                            <option value="firebase">üåç Yedek Sunucu (Firebase)</option>
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                            <i class="fas fa-caret-down"></i>
                        </div>
                    </div>
                </div>

                <!-- Oyna Butonu -->
                <button onclick="attemptPlay()" class="play-btn w-full py-3 text-3xl font-black uppercase tracking-wider interactive transform hover:scale-[1.02] active:scale-95">
                    OYNA
                </button>
            </div>
            
            <!-- Hata Mesajƒ± -->
            <div id="connection-status" class="hidden mt-4 bg-red-600 text-white px-6 py-2 rounded-full font-bold border-2 border-red-800 shadow-lg text-sm">
                <i class="fas fa-exclamation-circle mr-2"></i> <span id="conn-msg-text">Baƒülantƒ± Hatasƒ±</span>
            </div>
        </div>

        <!-- --- OYUN ARAY√úZ√ú (HUD) --- -->
        <div id="hud" class="absolute inset-0 pointer-events-none hidden">
            
            <!-- Sol √úst: Harita ve Itemler -->
            <div class="absolute top-4 left-4 flex gap-4 items-start">
                
                <!-- Mini Map -->
                <div id="minimap-wrapper">
                    <canvas id="minimap" width="140" height="140"></canvas>
                </div>

                <!-- Item Timerlarƒ± (Haritanƒ±n hemen saƒüƒ±na gelir) -->
                <div id="powerup-container" class="flex flex-col items-start w-[150px] pt-2">
                    <!-- Javascript ile doldurulur -->
                </div>
            </div>

            <!-- Saƒü √úst: Lider Tablosu -->
            <div class="absolute top-4 right-4 w-56">
                <div class="bg-black/40 backdrop-blur-sm rounded-xl p-3 border border-white/20">
                    <h3 class="text-white/90 text-xs uppercase mb-2 font-bold tracking-widest text-center border-b border-white/10 pb-1">Liderler</h3>
                    <ul id="leaderboard" class="space-y-1 text-sm font-bold text-white shadow-black drop-shadow-md">
                        <li class="flex justify-between text-yellow-300"><span>1. Y√ºkleniyor...</span><span>0</span></li>
                    </ul>
                </div>
            </div>

            <!-- Sol Alt: Skor -->
            <div class="absolute bottom-6 left-6">
                <div class="bg-black/40 backdrop-blur rounded-2xl px-5 py-3 border-2 border-white/20 transform hover:scale-110 transition-transform origin-bottom-left">
                    <span class="text-gray-300 text-[10px] uppercase block font-bold tracking-wider">K√ºtle</span>
                    <span id="score-display" class="text-4xl text-white font-black drop-shadow-md">10</span>
                </div>
            </div>
            
            <!-- Alt Orta: Kontrol Bilgisi -->
            <div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-white/50 text-[10px] font-sans text-center">
                wormeight.io clone
            </div>
        </div>

        <!-- --- √ñL√úM EKRANI --- -->
        <div id="death-screen" class="interactive hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900/95 backdrop-blur-md border-4 border-white/20 rounded-3xl p-8 text-center min-w-[320px] shadow-2xl">
            <h2 class="text-5xl text-[#ff7675] mb-2 drop-shadow-md font-black">ELENDƒ∞N!</h2>
            <div class="bg-white/10 rounded-xl p-4 mb-6">
                <p class="text-gray-300 text-xs uppercase tracking-widest">Son K√ºtle</p>
                <p class="text-white text-4xl font-bold text-[#ffeaa7]" id="final-score">0</p>
            </div>
            <button onclick="location.reload()" class="play-btn w-full py-3 text-xl font-bold uppercase">
                Tekrar Oyna
            </button>
            <div class="mt-4 text-white/40 text-xs">
                Reklamlar y√ºklenemedi.
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Yedek) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- OYUN AYARLARI (WORMATE Fƒ∞Zƒ∞KLERƒ∞) ---
        const CONFIG = {
            mapRadius: 3000,
            baseSpeed: 4.0,  
            boostSpeed: 8.5,
            turnSpeedFactor: 0.005, 
            minTurnSpeed: 0.04,
            widthBase: 24,
            growthFactor: 0.5,
            skins: [
                { id: 's1', type: 'stripe', c1: '#ff9f43', c2: '#ee5253' }, 
                { id: 's2', type: 'spot', c1: '#0abde3', c2: '#5f27cd' },   
                { id: 's3', type: 'solid', c1: '#10ac84', c2: '#1dd1a1' },  
                { id: 's4', type: 'stripe', c1: '#ff6b6b', c2: '#c8d6e5' }, 
                { id: 's5', type: 'spot', c1: '#feca57', c2: '#ff9f43' }    
            ]
        };

        const POWERUPS = {
            '2x':      { color: '#ff9ff3', label: '2x',      icon: 'fa-star',       duration: 60 },
            '5x':      { color: '#feca57', label: '5x',      icon: 'fa-crown',      duration: 40 },
            '10x':     { color: '#ff6b6b', label: '10x',     icon: 'fa-gem',        duration: 20 },
            'magnet':  { color: '#54a0ff', label: 'Mƒ±knatƒ±s',icon: 'fa-magnet',     duration: 40 },
            'agility': { color: '#00d2d3', label: '√áeviklik',icon: 'fa-wind',       duration: 40 },
            'speed':   { color: '#5f27cd', label: 'Hƒ±z',     icon: 'fa-bolt',       duration: 40 }
        };

        // Deƒüi≈ükenler
        let canvas, ctx, mmCanvas, mmCtx, skinCanvas, skinCtx;
        let myId = null, ws = null;
        let isPlaying = false, isBoosting = false, useFirebase = false;
        let mouse = { x: 0, y: 0, worldAngle: 0 };
        let camera = { x: 0, y: 0, scale: 0.8 };
        let animationFrameId;

        // Oyuncu
        let me = {
            x: 0, y: 0, angle: 0, history: [],
            length: 20, score: 10, width: CONFIG.widthBase, skinIdx: 0,
            effects: {}, dead: false
        };
        let enemies = new Map();
        let items = [];

        // --- INIT ---
        window.onload = () => {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d', { alpha: false });
            mmCanvas = document.getElementById('minimap');
            mmCtx = mmCanvas.getContext('2d');
            skinCanvas = document.getElementById('mm-skin-canv');
            skinCtx = skinCanvas.getContext('2d');

            resize();
            window.addEventListener('resize', resize);

            // Girdiler
            window.addEventListener('mousemove', e => {
                const cx = window.innerWidth / 2;
                const cy = window.innerHeight / 2;
                mouse.x = e.clientX;
                mouse.y = e.clientY;
                mouse.worldAngle = Math.atan2(e.clientY - cy, e.clientX - cx);
            });
            window.addEventListener('mousedown', () => isBoosting = true);
            window.addEventListener('mouseup', () => isBoosting = false);
            canvas.addEventListener('touchstart', (e) => { isBoosting = true; updateTouch(e); }, {passive:false});
            canvas.addEventListener('touchend', () => isBoosting = false);
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); updateTouch(e); }, {passive:false});

            animateSkinPreview();

            // Firebase Auth
            signInAnonymously(auth).then(u => {
                myId = u.user.uid;
            });
        };

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        function updateTouch(e) {
            const t = e.touches[0];
            const cx = window.innerWidth / 2;
            const cy = window.innerHeight / 2;
            mouse.worldAngle = Math.atan2(t.clientY - cy, t.clientX - cx);
        }

        // --- SKIN ---
        window.prevSkin = () => { me.skinIdx = (me.skinIdx - 1 + CONFIG.skins.length) % CONFIG.skins.length; };
        window.nextSkin = () => { me.skinIdx = (me.skinIdx + 1) % CONFIG.skins.length; };

        function animateSkinPreview() {
            let offset = 0;
            function loop() {
                offset += 0.1;
                skinCtx.clearRect(0,0,400,100);
                
                const skin = CONFIG.skins[me.skinIdx];
                const cx = 200, cy = 50;
                
                for(let i=0; i<30; i++) {
                    const x = cx - (i*10) + 100;
                    const y = cy + Math.sin(offset + i*0.2) * 15;
                    const w = 22;

                    skinCtx.beginPath();
                    skinCtx.arc(x, y, w/2, 0, Math.PI*2);
                    
                    if(skin.type === 'solid') skinCtx.fillStyle = skin.c1;
                    else if(skin.type === 'stripe') skinCtx.fillStyle = (i%3===0) ? skin.c2 : skin.c1;
                    else if(skin.type === 'spot') skinCtx.fillStyle = skin.c1;
                    
                    skinCtx.fill();
                    
                    const g = skinCtx.createRadialGradient(x-3, y-3, 1, x, y, w/2);
                    g.addColorStop(0, 'rgba(255,255,255,0.4)');
                    g.addColorStop(1, 'transparent');
                    skinCtx.fillStyle = g;
                    skinCtx.fill();

                    if(skin.type === 'spot' && i%4===0) {
                        skinCtx.beginPath(); skinCtx.arc(x,y, 5, 0, Math.PI*2); 
                        skinCtx.fillStyle = skin.c2; skinCtx.fill();
                    }
                }
                
                const hx = cx + 100, hy = cy + Math.sin(offset)*15;
                skinCtx.fillStyle='white';
                skinCtx.beginPath(); skinCtx.arc(hx+4, hy-6, 7, 0, Math.PI*2); skinCtx.fill();
                skinCtx.beginPath(); skinCtx.arc(hx+4, hy+6, 7, 0, Math.PI*2); skinCtx.fill();
                skinCtx.fillStyle='black';
                skinCtx.beginPath(); skinCtx.arc(hx+7, hy-6, 3, 0, Math.PI*2); skinCtx.fill();
                skinCtx.beginPath(); skinCtx.arc(hx+7, hy+6, 3, 0, Math.PI*2); skinCtx.fill();

                requestAnimationFrame(loop);
            }
            loop();
        }

        // --- BAƒûLANTI VE OYUN BA≈ûLATMA ---
        window.attemptPlay = () => {
            const srv = document.getElementById('server-select').value;
            const name = document.getElementById('username').value || "Worm";
            me.name = name;

            const statusEl = document.getElementById('connection-status');
            const statusText = document.getElementById('conn-msg-text');
            statusEl.classList.remove('hidden');
            statusEl.className = "mt-4 bg-yellow-600 text-white px-6 py-2 rounded-full font-bold border-2 border-yellow-800 shadow-lg text-sm";
            statusText.innerText = "Sunucuya baƒülanƒ±lƒ±yor...";

            if(srv === 'firebase') {
                useFirebase = true;
                startGame();
            } else {
                try {
                    ws = new WebSocket(srv);
                    ws.onopen = () => {
                        console.log("WS Connected");
                        useFirebase = false;
                        statusEl.classList.add('hidden');
                        startWebSocketSync();
                        startGame();
                    };
                    ws.onerror = () => {
                        console.log("WS Error");
                        statusEl.className = "mt-4 bg-red-600 text-white px-6 py-2 rounded-full font-bold border-2 border-red-800 shadow-lg text-sm";
                        statusText.innerText = "Sunucu Hatasƒ±! Firebase'e ge√ßiliyor...";
                        setTimeout(() => {
                            useFirebase = true; 
                            startGame();
                        }, 1500);
                    };
                    ws.onclose = () => {
                        if(isPlaying && !useFirebase) {
                            die(); 
                            alert("Sunucu baƒülantƒ±sƒ± koptu.");
                        }
                    };
                } catch(e) {
                    useFirebase = true;
                    startGame();
                }
            }
        };

        function startGame() {
            isPlaying = true;
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');

            me.score = 10;
            me.effects = {};
            me.dead = false;
            
            // Rastgele Doƒüu≈ü
            const a = Math.random() * Math.PI * 2;
            const r = Math.random() * CONFIG.mapRadius * 0.5;
            me.x = Math.cos(a) * r;
            me.y = Math.sin(a) * r;
            me.angle = Math.random() * Math.PI * 2;

            me.history = [];
            for(let i=0; i<20; i++) me.history.push({x: me.x, y: me.y});

            // Firebase modundaysak yemleri biz √ºretelim, WS ise sunucudan bekleyelim
            if(useFirebase) {
                generateLocalItems(300);
                startFirebaseSync();
            } else {
                items = []; // Sunucudan gelecek
            }
            
            cancelAnimationFrame(animationFrameId);
            gameLoop();
        }

        // --- OYUN D√ñNG√úS√ú ---
        function gameLoop() {
            if(!isPlaying) return;
            
            updatePhysics();
            render();
            updatePowerups();
            
            // Sunucuya Veri G√∂nder (WebSocket Modu)
            if (!useFirebase && ws && ws.readyState === WebSocket.OPEN) {
                 ws.send(JSON.stringify({
                     type: 'update',
                     x: Math.round(me.x),
                     y: Math.round(me.y),
                     angle: me.angle,
                     score: me.score,
                     name: me.name,
                     skin: me.skinIdx,
                     width: me.width,
                     history: me.history.filter((_, i) => i % 5 === 0)
                 }));
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- Fƒ∞Zƒ∞K ---
        function updatePhysics() {
            const now = Date.now();

            for(let k in me.effects) {
                if(me.effects[k] < now) delete me.effects[k];
            }

            let speed = CONFIG.baseSpeed;
            if(me.effects['speed']) speed *= 1.5;
            if(isBoosting && me.score > 15) {
                speed = CONFIG.boostSpeed;
                me.score -= 0.2; 
                if(me.score < 10) me.score = 10;
            }

            let turnSpeed = Math.max(CONFIG.minTurnSpeed, 0.12 - (me.width * 0.001));
            if(me.effects['agility']) turnSpeed *= 2.0;

            let diff = mouse.worldAngle - me.angle;
            while(diff <= -Math.PI) diff += Math.PI*2;
            while(diff > Math.PI) diff -= Math.PI*2;
            
            if(Math.abs(diff) < turnSpeed) me.angle = mouse.worldAngle;
            else me.angle += Math.sign(diff) * turnSpeed;

            me.x += Math.cos(me.angle) * speed;
            me.y += Math.sin(me.angle) * speed;

            if(Math.hypot(me.x, me.y) > CONFIG.mapRadius) {
                die();
                return;
            }

            me.history.unshift({x: me.x, y: me.y});
            me.width = CONFIG.widthBase + Math.sqrt(me.score)*0.6;
            const targetLen = 20 + Math.floor(me.score * 2); 
            while(me.history.length > targetLen) me.history.pop();

            // Yem Kontrol√º
            let pickupRange = me.width * 1.5;
            if(me.effects['magnet']) pickupRange *= 3.5;

            for(let i=items.length-1; i>=0; i--) {
                const it = items[i];
                const d = Math.hypot(it.x - me.x, it.y - me.y);

                if(d < pickupRange) {
                    it.x += (me.x - it.x) * 0.15;
                    it.y += (me.y - it.y) * 0.15;
                }

                if(d < me.width) {
                    // Yendi
                    if (useFirebase) {
                        // Yerel mantƒ±k
                        applyItemEffect(it);
                        items.splice(i, 1);
                        if(items.length < 50) generateLocalItems(20);
                    } else {
                        // Sunucuya bildir
                        ws.send(JSON.stringify({ type: 'eat', foodId: it.id }));
                        // ƒ∞stemci tarafƒ±nda tahmin (latency gizleme)
                        applyItemEffect(it);
                        items.splice(i, 1); 
                    }
                }
            }

            // D√º≈üman √áarpƒ±≈üma
            enemies.forEach(en => {
                if(!en.data.h) return;
                for(let i=0; i<en.data.h.length; i+=3) {
                    const p = en.data.h[i];
                    if(Math.hypot(me.x - p.x, me.y - p.y) < (me.width + (en.data.w||20))/2) {
                        die();
                    }
                }
            });

            camera.x += (me.x - camera.x) * 0.1;
            camera.y += (me.y - camera.y) * 0.1;
            camera.scale = Math.max(0.5, 0.9 - (me.width - CONFIG.widthBase)/500);
        }

        function applyItemEffect(it) {
            const now = Date.now();
            if(it.type === 'powerup') {
                me.effects[it.pType] = now + (POWERUPS[it.pType].duration * 1000);
            } else {
                let gain = it.val || 1;
                if(me.effects['2x']) gain *= 2;
                if(me.effects['5x']) gain *= 5;
                if(me.effects['10x']) gain *= 10;
                me.score += gain;
            }
        }

        function die() {
            me.dead = true;
            isPlaying = false;
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('death-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = Math.floor(me.score);
            
            if(useFirebase && myId) {
                deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', myId));
            } else if (!useFirebase && ws) {
                ws.send(JSON.stringify({ type: 'die' }));
            }
        }

        // --- RENDER ---
        function render() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            const bgX = -camera.x * camera.scale;
            const bgY = -camera.y * camera.scale;
            document.getElementById('game-bg').style.backgroundPosition = `${bgX}px ${bgY}px`;
            document.getElementById('game-bg').style.backgroundSize = `${80*camera.scale}px ${80*camera.scale}px`;

            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(camera.scale, camera.scale);
            ctx.translate(-camera.x, -camera.y);

            ctx.beginPath();
            ctx.arc(0, 0, CONFIG.mapRadius, 0, Math.PI*2);
            ctx.lineWidth = 40;
            ctx.strokeStyle = 'rgba(255,0,0,0.1)';
            ctx.stroke();
            ctx.lineWidth = 5;
            ctx.strokeStyle = '#e74c3c';
            ctx.stroke();

            items.forEach(it => {
                if(Math.abs(it.x-camera.x) > canvas.width && Math.abs(it.y-camera.y) > canvas.height) return;
                
                ctx.save();
                ctx.translate(it.x, it.y);

                if(it.type === 'powerup') {
                    const meta = POWERUPS[it.pType];
                    const scale = 1 + Math.sin(Date.now()/300)*0.1;
                    ctx.scale(scale, scale);
                    ctx.rotate(Math.sin(Date.now()/500)*0.2);

                    ctx.fillStyle = meta.color;
                    ctx.globalAlpha = 0.3;
                    ctx.beginPath(); ctx.arc(0,0, 25, 0, Math.PI*2); ctx.fill();
                    ctx.globalAlpha = 1;

                    ctx.fillStyle = meta.color;
                    ctx.shadowColor = meta.color;
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.moveTo(-10, -15);
                    ctx.lineTo(10, -15);
                    ctx.lineTo(15, 5);
                    ctx.quadraticCurveTo(15, 20, 0, 20);
                    ctx.quadraticCurveTo(-15, 20, -15, 5);
                    ctx.fill();
                    
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(meta.label.substring(0,2), 0, 5);

                } else {
                    const s = 10; 
                    ctx.fillStyle = it.color || 'red';
                    ctx.shadowColor = it.color || 'red';
                    ctx.shadowBlur = 5;
                    
                    if(it.kind === 'donut') {
                        ctx.beginPath(); ctx.arc(0,0,s,0,Math.PI*2); ctx.fill();
                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.beginPath(); ctx.arc(0,0,s*0.4,0,Math.PI*2); ctx.fill();
                        ctx.globalCompositeOperation = 'source-over';
                    } else {
                        ctx.beginPath(); ctx.arc(0,0,s,0,Math.PI*2); ctx.fill();
                        ctx.fillStyle = 'rgba(255,255,255,0.7)';
                        ctx.beginPath(); ctx.arc(-s*0.3, -s*0.3, s*0.3, 0, Math.PI*2); ctx.fill();
                    }
                }
                ctx.restore();
            });

            enemies.forEach(en => renderWorm(en.data, false));
            renderWorm({
                history: me.history,
                width: me.width,
                skinIdx: me.skinIdx,
                name: me.name
            }, true);

            ctx.restore();
            renderMinimap();
        }

        function renderWorm(w, isMe) {
            if(!w.history || w.history.length < 2) return;
            const skin = CONFIG.skins[w.skinIdx || 0];
            const wd = w.width || 20;

            const step = Math.max(1, Math.floor(wd / 8)); 
            
            for(let i = w.history.length-1; i >= 0; i -= step) {
                const p = w.history[i];
                let r = wd / 2;
                if(i > w.history.length - 10) r *= (w.history.length-i)/10;

                ctx.beginPath();
                ctx.arc(p.x, p.y, r, 0, Math.PI*2);
                
                if(skin.type === 'stripe') ctx.fillStyle = (Math.floor(i/5)%2===0) ? skin.c1 : skin.c2;
                else ctx.fillStyle = skin.c1;
                
                ctx.fill();

                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.beginPath();
                ctx.arc(p.x, p.y, r*0.7, 0, Math.PI*2);
                ctx.fill();

                if(skin.type === 'spot' && i%6===0) {
                    ctx.fillStyle = skin.c2;
                    ctx.beginPath(); ctx.arc(p.x, p.y, r*0.5, 0, Math.PI*2); ctx.fill();
                }
            }

            const head = w.history[0];
            let ang = isMe ? me.angle : 0;
            if(!isMe && w.history[5]) ang = Math.atan2(head.y - w.history[5].y, head.x - w.history[5].x);

            ctx.save();
            ctx.translate(head.x, head.y);
            ctx.rotate(ang);
            
            ctx.fillStyle = 'white';
            ctx.shadowBlur = 0;
            const eyOff = wd * 0.35;
            ctx.beginPath(); ctx.arc(wd*0.2, -eyOff, wd*0.3, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(wd*0.2, eyOff, wd*0.3, 0, Math.PI*2); ctx.fill();
            
            ctx.fillStyle = 'black';
            const lookX = wd*0.1;
            ctx.beginPath(); ctx.arc(wd*0.2 + lookX, -eyOff, wd*0.12, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(wd*0.2 + lookX, eyOff, wd*0.12, 0, Math.PI*2); ctx.fill();

            ctx.restore();

            if(!isMe) {
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.strokeText(w.name||'', head.x, head.y - wd);
                ctx.fillText(w.name||'', head.x, head.y - wd);
            }
        }

        function renderMinimap() {
            mmCtx.clearRect(0,0,140,140);
            const scale = 140 / (CONFIG.mapRadius * 2);
            const center = 70;

            mmCtx.strokeStyle = 'rgba(255,255,255,0.3)';
            mmCtx.lineWidth = 1;
            mmCtx.beginPath();
            mmCtx.arc(center, center, CONFIG.mapRadius * scale, 0, Math.PI*2);
            mmCtx.stroke();

            mmCtx.save();
            mmCtx.translate(center + me.x*scale, center + me.y*scale);
            mmCtx.rotate(me.angle);
            mmCtx.fillStyle = 'white';
            mmCtx.beginPath(); mmCtx.moveTo(5,0); mmCtx.lineTo(-4, 4); mmCtx.lineTo(-4, -4); mmCtx.fill();
            mmCtx.restore();

            mmCtx.fillStyle = '#ff4757';
            enemies.forEach(en => {
                if(en.data.h && en.data.h[0]) {
                    mmCtx.beginPath();
                    mmCtx.arc(center + en.data.h[0].x*scale, center + en.data.h[0].y*scale, 2, 0, Math.PI*2);
                    mmCtx.fill();
                }
            });
        }

        function updatePowerups() {
            const container = document.getElementById('powerup-container');
            container.innerHTML = '';
            const now = Date.now();
            
            for(let [k, expiry] of Object.entries(me.effects)) {
                const left = Math.ceil((expiry - now)/1000);
                const meta = POWERUPS[k];
                const div = document.createElement('div');
                div.className = 'powerup-timer';
                div.style.borderColor = meta.color;
                div.innerHTML = `<i class="fas ${meta.icon} mr-2" style="color:${meta.color}"></i> ${left}s`;
                container.appendChild(div);
            }
            document.getElementById('score-display').innerText = Math.floor(me.score);
        }

        // --- WEBSOCKET SYNC ---
        function startWebSocketSync() {
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'init') {
                    // Sunucudan gelen ba≈ülangƒ±√ß yemleri
                    items = data.food;
                }
                
                if (data.type === 'tick') {
                    // Diƒüer oyuncularƒ± g√ºncelle
                    data.players.forEach(p => {
                        if (p.id !== data.id) { // Kendimizi g√ºncelleme
                            enemies.set(p.id, { data: p });
                        }
                    });
                    
                    // Lider Tablosu
                    const list = data.players.map(p => ({n: p.n, s: p.s}));
                    list.sort((a,b) => b.s - a.s);
                    document.getElementById('leaderboard').innerHTML = list.slice(0,5).map((p,i)=>`
                        <li class="flex justify-between border-b border-white/10 pb-1 ${p.n===me.name?'text-yellow-300':''}">
                            <span>${i+1}. ${p.n.substring(0,10)}</span>
                            <span>${p.s}</span>
                        </li>`).join('');
                }

                if (data.type === 'food_eaten') {
                    const idx = items.findIndex(i => i.id === data.id);
                    if (idx !== -1) items.splice(idx, 1);
                }

                if (data.type === 'food_new') {
                    items.push(data.item);
                }

                if (data.type === 'player_left') {
                    enemies.delete(data.id);
                }
            };
        }

        // --- YEREL YEM √úRETƒ∞Mƒ∞ (SADECE FIREBASE MODU ƒ∞√áƒ∞N) ---
        function generateLocalItems(cnt) {
            const kinds = ['donut', 'cake', 'candy'];
            const pTypes = Object.keys(POWERUPS);
            for(let i=0; i<cnt; i++) {
                const isP = Math.random() < 0.05; 
                const r = Math.random() * CONFIG.mapRadius;
                const a = Math.random() * Math.PI * 2;
                
                if(isP) {
                    items.push({
                        id: Math.random(),
                        type: 'powerup',
                        pType: pTypes[Math.floor(Math.random()*pTypes.length)],
                        x: Math.cos(a)*r, y: Math.sin(a)*r
                    });
                } else {
                    items.push({
                        id: Math.random(),
                        type: 'food',
                        kind: kinds[Math.floor(Math.random()*kinds.length)],
                        x: Math.cos(a)*r, y: Math.sin(a)*r,
                        color: `hsl(${Math.random()*360}, 80%, 60%)`
                    });
                }
            }
        }

        // --- FIREBASE SYNC ---
        function startFirebaseSync() {
            const ref = collection(db, 'artifacts', appId, 'public', 'data', 'players');
            onSnapshot(ref, snap => {
                const list = [];
                snap.docChanges().forEach(c => {
                    const d = c.doc.data();
                    const id = c.doc.id;
                    if(id === myId) return;
                    if(c.type === 'removed') enemies.delete(id);
                    else enemies.set(id, { data: d });
                });
                snap.forEach(d => list.push({n:d.data().n, s:d.data().s}));
                list.push({n: me.name, s: Math.floor(me.score)});
                list.sort((a,b)=>b.s - a.s);
                document.getElementById('leaderboard').innerHTML = list.slice(0,5).map((p,i)=>`
                    <li class="flex justify-between border-b border-white/10 pb-1 ${p.n===me.name?'text-yellow-300':''}">
                        <span>${i+1}. ${p.n.substring(0,10)}</span>
                        <span>${p.s}</span>
                    </li>`).join('');
            });
            setInterval(() => {
                if(!isPlaying || me.dead) return;
                const sparse = me.history.filter((_,i)=>i%5===0);
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', myId), {
                    n: me.name, s: Math.floor(me.score), skinIdx: me.skinIdx,
                    h: sparse, w: Math.floor(me.width), ts: serverTimestamp()
                }).catch(()=>{});
            }, 100);
        }
    </script>
</body>
</html>
